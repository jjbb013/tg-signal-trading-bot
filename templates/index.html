<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Telegram ç›‘å¬æœºå™¨äºº</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/main.css">
</head>
<body>
    <div class="mobile-container">
        <!-- æœºå™¨äººçŠ¶æ€ -->
        <div class="status-section">
            <h2>ğŸ¤– æœºå™¨äººçŠ¶æ€</h2>
            <div class="status-content">
                <div class="status-item">
                    <span class="status-label">è¿è¡ŒçŠ¶æ€:</span>
                    <span class="status-value" id="bot-status">
                        {% if config and config.is_running %}
                        <span class="status-running">ğŸŸ¢ è¿è¡Œä¸­</span>
                        {% else %}
                        <span class="status-stopped">ğŸ”´ å·²åœæ­¢</span>
                        {% endif %}
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">SessionçŠ¶æ€:</span>
                    <span class="status-value" id="session-status">
                        <span class="status-checking">â³ æ£€æµ‹ä¸­...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">ç›‘å¬ç¾¤ç»„:</span>
                    <span class="status-value">{{ groups|length }} ä¸ª</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æœ€åæ›´æ–°:</span>
                    <span class="status-value" id="last-update">{{ "åˆšåˆš" }}</span>
                </div>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="log-section">
            <div class="log-header">
                <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
                <div class="log-controls">
                    <button class="btn btn-small" onclick="clearLogArea()">ğŸ§¹ æ¸…å±</button>
                    <button class="btn btn-small" onclick="switchLogMode()" id="log-mode-btn">ğŸ“š å†å²</button>
                </div>
            </div>
            <div class="log-area" id="log-area">
                {% for log in logs %}
                <div class="log-bubble">{{ log.content }}</div>
                {% endfor %}
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥è¯¢ -->
        <div class="log-query-section">
            <h2>ğŸ“‹ æ—¥å¿—æŸ¥è¯¢</h2>
            <div class="log-query-controls">
                <select id="log-date-select" class="log-select"></select>
                <button class="btn btn-query" onclick="loadLogFile()">ğŸ“– æŸ¥çœ‹</button>
            </div>
            <textarea id="log-file-content" class="log-textarea" readonly placeholder="é€‰æ‹©æ—¥æœŸæŸ¥çœ‹å†å²æ—¥å¿—..."></textarea>
        </div>

        <!-- ç¾¤ç»„ç®¡ç† -->
        <div class="group-section">
            <h2>ğŸ‘¥ ç›‘å¬ç¾¤ç»„</h2>
            <form method="post" action="/group/add" class="group-form">
                <div class="input-group">
                    <input name="group_id" placeholder="è¾“å…¥ç¾¤ç»„ ID" class="group-input">
                    <button type="submit" class="btn btn-add">â• æ·»åŠ </button>
                </div>
            </form>
            <div class="group-list">
                {% for group in groups %}
                <div class="group-item">
                    <span class="group-id">{{ group.group_id }}</span>
                    <form method="post" action="/group/delete" style="display:inline;">
                        <input type="hidden" name="group_id" value="{{ group.group_id }}">
                        <button type="submit" class="btn btn-delete">ğŸ—‘ï¸</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="config-section">
            <h2>ğŸ“± é…ç½®ä¿¡æ¯</h2>
            <form method="post" action="/config" class="config-form">
                <div class="form-group">
                    <label>API ID:</label>
                    <input name="api_id" value="{{ config.api_id if config else '' }}" placeholder="è¾“å…¥ API ID">
                </div>
                <div class="form-group">
                    <label>API Hash:</label>
                    <input name="api_hash" value="{{ config.api_hash if config else '' }}" placeholder="è¾“å…¥ API Hash">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·:</label>
                    <input name="phone_number" value="{{ config.phone_number if config else '' }}" placeholder="+8613...">
                </div>
                <div class="form-group">
                    <label>Bark Key:</label>
                    <input name="bark_api_key" value="{{ config.bark_api_key if config else '' }}" placeholder="Bark æ¨é€å¯†é’¥">
                </div>
                <div class="form-group">
                    <label>æ—¥å¿—ç¾¤ç»„:</label>
                    <input name="log_group_id" value="{{ config.log_group_id if config else '' }}" placeholder="æ—¥å¿—ç¾¤ç»„ ID">
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </form>
        </div>
    </div>

    <script>
    let logMode = 'realtime'; // 'realtime' or 'file'
    let lastUpdateTime = new Date();
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    function updateLastUpdate() {
        const now = new Date();
        const diff = Math.floor((now - lastUpdateTime) / 1000);
        let timeStr = '';
        if (diff < 60) {
            timeStr = 'åˆšåˆš';
        } else if (diff < 3600) {
            timeStr = `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
        } else {
            timeStr = `${Math.floor(diff / 3600)}å°æ—¶å‰`;
        }
        document.getElementById('last-update').textContent = timeStr;
    }
    
    // æ£€æŸ¥SessionçŠ¶æ€
    function checkSessionStatus() {
        fetch('/session/status')
            .then(res => res.json())
            .then(data => {
                const sessionStatus = document.getElementById('session-status');
                if (data.valid) {
                    sessionStatus.innerHTML = '<span class="status-valid">âœ… æœ‰æ•ˆ</span>';
                } else {
                    sessionStatus.innerHTML = '<span class="status-invalid">âŒ æ— æ•ˆ</span>';
                    // å¦‚æœSessionæ— æ•ˆï¼Œå‘é€Barké€šçŸ¥
                    if (data.bark_sent) {
                        console.log('Barké€šçŸ¥å·²å‘é€');
                    }
                }
            })
            .catch(err => {
                document.getElementById('session-status').innerHTML = '<span class="status-error">âš ï¸ æ£€æµ‹å¤±è´¥</span>';
            });
    }
    
    // æ£€æŸ¥æœºå™¨äººçŠ¶æ€
    function checkBotStatus() {
        fetch('/bot/status')
            .then(res => res.json())
            .then(data => {
                const botStatus = document.getElementById('bot-status');
                if (data.running) {
                    botStatus.innerHTML = '<span class="status-running">ğŸŸ¢ è¿è¡Œä¸­</span>';
                } else {
                    botStatus.innerHTML = '<span class="status-stopped">ğŸ”´ å·²åœæ­¢</span>';
                }
                lastUpdateTime = new Date();
                updateLastUpdate();
            })
            .catch(err => {
                document.getElementById('bot-status').innerHTML = '<span class="status-error">âš ï¸ æ£€æµ‹å¤±è´¥</span>';
            });
    }
    
    function fetchLogs() {
        if(logMode !== 'realtime') return;
        fetch('/logs')
            .then(res => res.json())
            .then(data => {
                const logArea = document.getElementById('log-area');
                logArea.innerHTML = '';
                data.logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'log-bubble';
                    div.textContent = log;
                    logArea.appendChild(div);
                });
                logArea.scrollTop = logArea.scrollHeight;
            });
    }
    
    function clearLogArea() {
        document.getElementById('log-area').innerHTML = '';
    }
    
    function switchLogMode() {
        if(logMode === 'realtime') {
            logMode = 'file';
            document.getElementById('log-mode-btn').textContent = 'ğŸ“º å®æ—¶';
            document.getElementById('log-area').innerHTML = '<div class="log-placeholder">è¯·åœ¨æ—¥å¿—æŸ¥è¯¢åŒºåŸŸé€‰æ‹©æ—¥æœŸå¹¶æŸ¥çœ‹æ—¥å¿—</div>';
        } else {
            logMode = 'realtime';
            document.getElementById('log-mode-btn').textContent = 'ğŸ“š å†å²';
            fetchLogs();
        }
    }
    
    // æ—¥å¿—æ–‡ä»¶æŸ¥è¯¢
    function loadLogFileList() {
        fetch('/logs/list').then(res=>res.json()).then(data=>{
            const sel = document.getElementById('log-date-select');
            sel.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸ...</option>';
            data.files.forEach(f=>{
                const date = f.replace('.log','');
                const opt = document.createElement('option');
                opt.value = date;
                opt.textContent = date;
                sel.appendChild(opt);
            });
        });
    }
    
    function loadLogFile() {
        const date = document.getElementById('log-date-select').value;
        if(!date) return;
        fetch('/logs/file?date='+date).then(res=>res.json()).then(data=>{
            document.getElementById('log-file-content').value = data.content || '';
            if(logMode === 'file') {
                document.getElementById('log-area').innerHTML = '';
                data.content.split('\n').forEach(line=>{
                    if(line.trim()){
                        const div = document.createElement('div');
                        div.className = 'log-bubble';
                        div.textContent = line;
                        document.getElementById('log-area').appendChild(div);
                    }
                });
            }
        });
    }
    
    // åˆå§‹åŒ–
    loadLogFileList();
    checkSessionStatus();
    checkBotStatus();
    
    // å®šæ—¶æ›´æ–°
    setInterval(fetchLogs, 2000);
    setInterval(checkBotStatus, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æœºå™¨äººçŠ¶æ€
    setInterval(checkSessionStatus, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡SessionçŠ¶æ€
    setInterval(updateLastUpdate, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
    </script>
</body>
</html> 