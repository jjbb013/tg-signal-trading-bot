<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Telegram 监听机器人</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/main.css">
</head>
<body>
    <div class="mobile-container">
        <!-- 机器人状态 -->
        <div class="status-section">
            <h2>🤖 机器人状态</h2>
            <div class="status-content">
                <div class="status-item">
                    <span class="status-label">运行状态:</span>
                    <span class="status-value" id="bot-status">
                        {% if config and config.is_running %}
                        <span class="status-running">🟢 运行中</span>
                        {% else %}
                        <span class="status-stopped">🔴 已停止</span>
                        {% endif %}
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">Session状态:</span>
                    <span class="status-value" id="session-status">
                        <span class="status-checking">⏳ 检测中...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">监听群组:</span>
                    <span class="status-value">{{ groups|length }} 个</span>
                </div>
                <div class="status-item">
                    <span class="status-label">最后更新:</span>
                    <span class="status-value" id="last-update">{{ "刚刚" }}</span>
                </div>
            </div>
        </div>

        <!-- 实时日志 -->
        <div class="log-section">
            <div class="log-header">
                <h2>📝 实时日志</h2>
                <div class="log-controls">
                    <button class="btn btn-small" onclick="clearLogArea()">🧹 清屏</button>
                    <button class="btn btn-small" onclick="switchLogMode()" id="log-mode-btn">📚 历史</button>
                </div>
            </div>
            <div class="log-area" id="log-area">
                {% for log in logs %}
                <div class="log-bubble">{{ log.content }}</div>
                {% endfor %}
            </div>
        </div>

        <!-- 日志查询 -->
        <div class="log-query-section">
            <h2>📋 日志查询</h2>
            <div class="log-query-controls">
                <select id="log-date-select" class="log-select"></select>
                <button class="btn btn-query" onclick="loadLogFile()">📖 查看</button>
            </div>
            <textarea id="log-file-content" class="log-textarea" readonly placeholder="选择日期查看历史日志..."></textarea>
        </div>

        <!-- 群组管理 -->
        <div class="group-section">
            <h2>👥 监听群组</h2>
            <form method="post" action="/group/add" class="group-form">
                <div class="input-group">
                    <input name="group_id" placeholder="输入群组 ID" class="group-input">
                    <button type="submit" class="btn btn-add">➕ 添加</button>
                </div>
            </form>
            <div class="group-list">
                {% for group in groups %}
                <div class="group-item">
                    <span class="group-id">{{ group.group_id }}</span>
                    <form method="post" action="/group/delete" style="display:inline;">
                        <input type="hidden" name="group_id" value="{{ group.group_id }}">
                        <button type="submit" class="btn btn-delete">🗑️</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 配置区域 -->
        <div class="config-section">
            <h2>📱 配置信息</h2>
            <form method="post" action="/config" class="config-form">
                <div class="form-group">
                    <label>API ID:</label>
                    <input name="api_id" value="{{ config.api_id if config else '' }}" placeholder="输入 API ID">
                </div>
                <div class="form-group">
                    <label>API Hash:</label>
                    <input name="api_hash" value="{{ config.api_hash if config else '' }}" placeholder="输入 API Hash">
                </div>
                <div class="form-group">
                    <label>手机号:</label>
                    <input name="phone_number" value="{{ config.phone_number if config else '' }}" placeholder="+8613...">
                </div>
                <div class="form-group">
                    <label>Bark Key:</label>
                    <input name="bark_api_key" value="{{ config.bark_api_key if config else '' }}" placeholder="Bark 推送密钥">
                </div>
                <div class="form-group">
                    <label>日志群组:</label>
                    <input name="log_group_id" value="{{ config.log_group_id if config else '' }}" placeholder="日志群组 ID">
                </div>
                <button type="submit" class="btn btn-primary">💾 保存配置</button>
            </form>
        </div>
    </div>

    <script>
    let logMode = 'realtime'; // 'realtime' or 'file'
    let lastUpdateTime = new Date();
    
    // 更新最后更新时间
    function updateLastUpdate() {
        const now = new Date();
        const diff = Math.floor((now - lastUpdateTime) / 1000);
        let timeStr = '';
        if (diff < 60) {
            timeStr = '刚刚';
        } else if (diff < 3600) {
            timeStr = `${Math.floor(diff / 60)}分钟前`;
        } else {
            timeStr = `${Math.floor(diff / 3600)}小时前`;
        }
        document.getElementById('last-update').textContent = timeStr;
    }
    
    // 检查Session状态
    function checkSessionStatus() {
        fetch('/session/status')
            .then(res => res.json())
            .then(data => {
                const sessionStatus = document.getElementById('session-status');
                if (data.valid) {
                    sessionStatus.innerHTML = '<span class="status-valid">✅ 有效</span>';
                } else {
                    sessionStatus.innerHTML = '<span class="status-invalid">❌ 无效</span>';
                    // 如果Session无效，发送Bark通知
                    if (data.bark_sent) {
                        console.log('Bark通知已发送');
                    }
                }
            })
            .catch(err => {
                document.getElementById('session-status').innerHTML = '<span class="status-error">⚠️ 检测失败</span>';
            });
    }
    
    // 检查机器人状态
    function checkBotStatus() {
        fetch('/bot/status')
            .then(res => res.json())
            .then(data => {
                const botStatus = document.getElementById('bot-status');
                if (data.running) {
                    botStatus.innerHTML = '<span class="status-running">🟢 运行中</span>';
                } else {
                    botStatus.innerHTML = '<span class="status-stopped">🔴 已停止</span>';
                }
                lastUpdateTime = new Date();
                updateLastUpdate();
            })
            .catch(err => {
                document.getElementById('bot-status').innerHTML = '<span class="status-error">⚠️ 检测失败</span>';
            });
    }
    
    function fetchLogs() {
        if(logMode !== 'realtime') return;
        fetch('/logs')
            .then(res => res.json())
            .then(data => {
                const logArea = document.getElementById('log-area');
                logArea.innerHTML = '';
                data.logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'log-bubble';
                    div.textContent = log;
                    logArea.appendChild(div);
                });
                logArea.scrollTop = logArea.scrollHeight;
            });
    }
    
    function clearLogArea() {
        document.getElementById('log-area').innerHTML = '';
    }
    
    function switchLogMode() {
        if(logMode === 'realtime') {
            logMode = 'file';
            document.getElementById('log-mode-btn').textContent = '📺 实时';
            document.getElementById('log-area').innerHTML = '<div class="log-placeholder">请在日志查询区域选择日期并查看日志</div>';
        } else {
            logMode = 'realtime';
            document.getElementById('log-mode-btn').textContent = '📚 历史';
            fetchLogs();
        }
    }
    
    // 日志文件查询
    function loadLogFileList() {
        fetch('/logs/list').then(res=>res.json()).then(data=>{
            const sel = document.getElementById('log-date-select');
            sel.innerHTML = '<option value="">选择日期...</option>';
            data.files.forEach(f=>{
                const date = f.replace('.log','');
                const opt = document.createElement('option');
                opt.value = date;
                opt.textContent = date;
                sel.appendChild(opt);
            });
        });
    }
    
    function loadLogFile() {
        const date = document.getElementById('log-date-select').value;
        if(!date) return;
        fetch('/logs/file?date='+date).then(res=>res.json()).then(data=>{
            document.getElementById('log-file-content').value = data.content || '';
            if(logMode === 'file') {
                document.getElementById('log-area').innerHTML = '';
                data.content.split('\n').forEach(line=>{
                    if(line.trim()){
                        const div = document.createElement('div');
                        div.className = 'log-bubble';
                        div.textContent = line;
                        document.getElementById('log-area').appendChild(div);
                    }
                });
            }
        });
    }
    
    // 初始化
    loadLogFileList();
    checkSessionStatus();
    checkBotStatus();
    
    // 定时更新
    setInterval(fetchLogs, 2000);
    setInterval(checkBotStatus, 10000); // 每10秒检查一次机器人状态
    setInterval(checkSessionStatus, 30000); // 每30秒检查一次Session状态
    setInterval(updateLastUpdate, 60000); // 每分钟更新一次时间显示
    </script>
</body>
</html> 