name: Deploy to Northflank

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Northflank
      run: |
        echo "🚀 开始部署到 Northflank..."
        
        # 检查必要的secrets
        if [ -z "${{ secrets.NORTHFLANK_TOKEN }}" ]; then
          echo "❌ 错误: NORTHFLANK_TOKEN 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_TEAM_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_TEAM_ID 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_PROJECT_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_PROJECT_ID 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_SERVICE_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_SERVICE_ID 未设置"
          exit 1
        fi
        
        # 构建部署请求 - 使用正确的API端点
        DEPLOY_URL="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/deployment"
        
        echo "📡 请求URL: $DEPLOY_URL"
        
        # 创建部署 - 使用PUT请求和正确的payload格式
        echo "📦 创建部署..."
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X PUT \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"name\": \"${{ secrets.NORTHFLANK_SERVICE_ID }}\",
            \"description\": \"Telegram监听机器人服务 - Auto deploy from GitHub Actions\",
            \"billing\": {
              \"deploymentPlan\": \"nf-compute-20\"
            },
            \"deployment\": {
              \"instances\": 1,
              \"docker\": {
                \"configType\": \"default\"
              },
              \"storage\": {
                \"ephemeralStorage\": {
                  \"storageSize\": 1024
                }
              },
              \"internal\": {
                \"id\": \"${{ secrets.NORTHFLANK_SERVICE_ID }}\",
                \"branch\": \"${{ github.ref_name }}\",
                \"buildId\": \"${{ github.sha }}\"
              }
            },
            \"ports\": [
              {
                \"name\": \"p01\",
                \"internalPort\": 8080,
                \"public\": true,
                \"protocol\": \"HTTP\"
              }
            ]
          }" \
          "$DEPLOY_URL")
        
        # 解析响应
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
          echo "✅ 部署请求已发送"
          echo "📋 响应: $RESPONSE_BODY"
          
          # 可选：等待部署完成
          if [ "${{ vars.WAIT_FOR_DEPLOYMENT }}" = "true" ]; then
            echo "⏳ 等待部署完成..."
            sleep 30
            echo "✅ 部署完成"
          fi
        else
          echo "❌ 部署失败"
          echo "📋 响应代码: $HTTP_CODE"
          echo "📋 响应内容: $RESPONSE_BODY"
          exit 1
        fi
        
        echo "🎉 部署流程完成！" 