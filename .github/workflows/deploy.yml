name: Deploy to Northflank

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Northflank
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Northflank..."
        
        # æ£€æŸ¥å¿…è¦çš„secrets
        if [ -z "${{ secrets.NORTHFLANK_TOKEN }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_TOKEN æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_TEAM_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_TEAM_ID æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_PROJECT_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_PROJECT_ID æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_SERVICE_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_SERVICE_ID æœªè®¾ç½®"
          exit 1
        fi
        
        # æ„å»ºéƒ¨ç½²è¯·æ±‚
        DEPLOY_URL="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_TEAM_ID }}/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/${{ secrets.NORTHFLANK_SERVICE_ID }}/deployments"
        
        echo "ğŸ“¡ è¯·æ±‚URL: $DEPLOY_URL"
        
        # åˆ›å»ºéƒ¨ç½²
        echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²..."
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"branch\": \"${{ github.ref_name }}\",
            \"commitSha\": \"${{ github.sha }}\",
            \"message\": \"Auto deploy from GitHub Actions - ${{ github.event.head_commit.message }}\"
          }" \
          "$DEPLOY_URL")
        
        # è§£æå“åº”
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… éƒ¨ç½²è¯·æ±‚å·²å‘é€"
          echo "ğŸ“‹ å“åº”: $RESPONSE_BODY"
          
          # å¯é€‰ï¼šç­‰å¾…éƒ¨ç½²å®Œæˆ
          if [ "${{ vars.WAIT_FOR_DEPLOYMENT }}" = "true" ]; then
            echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
            sleep 30
            echo "âœ… éƒ¨ç½²å®Œæˆ"
          fi
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "ğŸ“‹ å“åº”ä»£ç : $HTTP_CODE"
          echo "ğŸ“‹ å“åº”å†…å®¹: $RESPONSE_BODY"
          exit 1
        fi
        
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼" 