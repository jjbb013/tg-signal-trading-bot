name: Deploy to Northflank

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Northflank
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Northflank..."
        
        # æ£€æŸ¥å¿…è¦çš„secrets
        if [ -z "${{ secrets.NORTHFLANK_TOKEN }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_TOKEN æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_TEAM_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_TEAM_ID æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_PROJECT_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_PROJECT_ID æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_SERVICE_ID }}" ]; then
          echo "âŒ é”™è¯¯: NORTHFLANK_SERVICE_ID æœªè®¾ç½®"
          exit 1
        fi
        
        # å°è¯•ä¸åŒçš„APIè·¯å¾„æ ¼å¼
        echo "ğŸ”„ å°è¯•éƒ¨ç½²..."
        
        # è·¯å¾„1: ä¸åŒ…å«å›¢é˜ŸID
        DEPLOY_URL_1="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/${{ secrets.NORTHFLANK_SERVICE_ID }}/deployments"
        echo "ğŸ“¡ å°è¯•è·¯å¾„1: $DEPLOY_URL_1"
        
        RESPONSE_1=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"branch\": \"${{ github.ref_name }}\",
            \"commitSha\": \"${{ github.sha }}\",
            \"message\": \"Auto deploy from GitHub Actions - ${{ github.event.head_commit.message }}\"
          }" \
          "$DEPLOY_URL_1")
        
        HTTP_CODE_1=$(echo "$RESPONSE_1" | tail -n1)
        RESPONSE_BODY_1=$(echo "$RESPONSE_1" | head -n -1)
        
        echo "ğŸ“‹ è·¯å¾„1å“åº”ä»£ç : $HTTP_CODE_1"
        
        if [ "$HTTP_CODE_1" -eq 201 ] || [ "$HTTP_CODE_1" -eq 200 ]; then
          echo "âœ… è·¯å¾„1éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“‹ å“åº”: $RESPONSE_BODY_1"
          exit 0
        fi
        
        # è·¯å¾„2: åŒ…å«å›¢é˜ŸID
        echo "ğŸ”„ è·¯å¾„1å¤±è´¥ï¼Œå°è¯•è·¯å¾„2..."
        DEPLOY_URL_2="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_TEAM_ID }}/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/${{ secrets.NORTHFLANK_SERVICE_ID }}/deployments"
        echo "ğŸ“¡ å°è¯•è·¯å¾„2: $DEPLOY_URL_2"
        
        RESPONSE_2=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"branch\": \"${{ github.ref_name }}\",
            \"commitSha\": \"${{ github.sha }}\",
            \"message\": \"Auto deploy from GitHub Actions - ${{ github.event.head_commit.message }}\"
          }" \
          "$DEPLOY_URL_2")
        
        HTTP_CODE_2=$(echo "$RESPONSE_2" | tail -n1)
        RESPONSE_BODY_2=$(echo "$RESPONSE_2" | head -n -1)
        
        echo "ğŸ“‹ è·¯å¾„2å“åº”ä»£ç : $HTTP_CODE_2"
        
        if [ "$HTTP_CODE_2" -eq 201 ] || [ "$HTTP_CODE_2" -eq 200 ]; then
          echo "âœ… è·¯å¾„2éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“‹ å“åº”: $RESPONSE_BODY_2"
          exit 0
        fi
        
        # å¦‚æœä¸¤ç§è·¯å¾„éƒ½å¤±è´¥
        echo "âŒ æ‰€æœ‰è·¯å¾„éƒ½å¤±è´¥"
        echo "ğŸ“‹ è·¯å¾„1å“åº”: $RESPONSE_BODY_1"
        echo "ğŸ“‹ è·¯å¾„2å“åº”: $RESPONSE_BODY_2"
        echo ""
        echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
        echo "1. å›¢é˜ŸIDã€é¡¹ç›®IDæˆ–æœåŠ¡IDä¸æ­£ç¡®"
        echo "2. API Tokenæ— æ•ˆæˆ–è¿‡æœŸ"
        echo "3. æƒé™ä¸è¶³"
        echo "4. APIè·¯å¾„æ ¼å¼é”™è¯¯"
        exit 1 