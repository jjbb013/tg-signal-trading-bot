name: Deploy to Northflank

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Northflank
      run: |
        echo "🚀 开始部署到 Northflank..."
        
        # 检查必要的secrets
        if [ -z "${{ secrets.NORTHFLANK_TOKEN }}" ]; then
          echo "❌ 错误: NORTHFLANK_TOKEN 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_TEAM_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_TEAM_ID 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_PROJECT_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_PROJECT_ID 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.NORTHFLANK_SERVICE_ID }}" ]; then
          echo "❌ 错误: NORTHFLANK_SERVICE_ID 未设置"
          exit 1
        fi
        
        # 尝试不同的API路径格式
        echo "🔄 尝试部署..."
        
        # 路径1: 不包含团队ID
        DEPLOY_URL_1="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/${{ secrets.NORTHFLANK_SERVICE_ID }}/deployments"
        echo "📡 尝试路径1: $DEPLOY_URL_1"
        
        RESPONSE_1=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"branch\": \"${{ github.ref_name }}\",
            \"commitSha\": \"${{ github.sha }}\",
            \"message\": \"Auto deploy from GitHub Actions - ${{ github.event.head_commit.message }}\"
          }" \
          "$DEPLOY_URL_1")
        
        HTTP_CODE_1=$(echo "$RESPONSE_1" | tail -n1)
        RESPONSE_BODY_1=$(echo "$RESPONSE_1" | head -n -1)
        
        echo "📋 路径1响应代码: $HTTP_CODE_1"
        
        if [ "$HTTP_CODE_1" -eq 201 ] || [ "$HTTP_CODE_1" -eq 200 ]; then
          echo "✅ 路径1部署成功"
          echo "📋 响应: $RESPONSE_BODY_1"
          exit 0
        fi
        
        # 路径2: 包含团队ID
        echo "🔄 路径1失败，尝试路径2..."
        DEPLOY_URL_2="https://api.northflank.com/v1/projects/${{ secrets.NORTHFLANK_TEAM_ID }}/${{ secrets.NORTHFLANK_PROJECT_ID }}/services/${{ secrets.NORTHFLANK_SERVICE_ID }}/deployments"
        echo "📡 尝试路径2: $DEPLOY_URL_2"
        
        RESPONSE_2=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.NORTHFLANK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"branch\": \"${{ github.ref_name }}\",
            \"commitSha\": \"${{ github.sha }}\",
            \"message\": \"Auto deploy from GitHub Actions - ${{ github.event.head_commit.message }}\"
          }" \
          "$DEPLOY_URL_2")
        
        HTTP_CODE_2=$(echo "$RESPONSE_2" | tail -n1)
        RESPONSE_BODY_2=$(echo "$RESPONSE_2" | head -n -1)
        
        echo "📋 路径2响应代码: $HTTP_CODE_2"
        
        if [ "$HTTP_CODE_2" -eq 201 ] || [ "$HTTP_CODE_2" -eq 200 ]; then
          echo "✅ 路径2部署成功"
          echo "📋 响应: $RESPONSE_BODY_2"
          exit 0
        fi
        
        # 如果两种路径都失败
        echo "❌ 所有路径都失败"
        echo "📋 路径1响应: $RESPONSE_BODY_1"
        echo "📋 路径2响应: $RESPONSE_BODY_2"
        echo ""
        echo "🔍 可能的原因："
        echo "1. 团队ID、项目ID或服务ID不正确"
        echo "2. API Token无效或过期"
        echo "3. 权限不足"
        echo "4. API路径格式错误"
        exit 1 